# frequency_counte

### **摘要**

本课程设计报告围绕数字频率计展开。数字频率计作为一种重要的电子测量仪器，在电子工程等领域具有广泛的应用。本次课程设计详细阐述了数字频率计的设计原理、实现方法及测试过程。通过对电路的精心设计和调试，实现了对输入信号频率的准确测量。该数字频率计具有测量精度高、稳定性好、操作简便等特点。在设计过程中，充分运用了数字电路的相关知识，包括计数器、寄存器、译码器等逻辑器件的应用。经过实际测试，该数字频率计能够准确地测量不同频率范围内的信号，满足了课程设计的要求，为电子测量技术的学习和实践提供了有益的参考。
本文设计了一种创新的数字频率计，采用输入捕获方法代替传统的等效采样方法进行频率测量。相比等效采样法，输入捕获法在精度和测量范围方面具有显著优势。该方法不仅提高了频率计的测量准确度，还能够在更广的频率范围内稳定运行，实现高达0.5%以内的测量误差。通过输入捕获技术，本设计满足了高精度测量的要求，且在整个设计频率范围内无需频段切换，极大地简化了系统结构并提升了操作便捷性。
由于本次设计采用了输入捕获的方法和流水线设计，实现了从测量到输出结果为微秒级延迟。相比于传统的等效测量法对于部分频率的测量需要 10 秒的情况，这是一个极大的提升。这种创新的设计不仅提高了测量的速度，还增强了系统的实时性和响应能力，能够更好地满足现代电子测量领域对于快速、准确测量的需求。同时，流水线设计也提高了系统的处理效率，使得多个测量任务可以同时进行，进一步提升了系统的性能。

### **第一章 技术指标**

#### **1.1 系统的功能要求**

本系统的主要功能是高精度测量输入信号的频率、周期和脉宽。通过创新的输入捕获方法，系统在宽测量范围内实现了较高的测量精度，并将频率、周期和脉宽的测量误差控制在0.5%以内。系统支持实时显示测量结果，适应正弦波、三角波和矩形波等不同类型的输入信号，满足多种测量需求。

#### **1.2 系统的结构要求**

系统由输入信号模块、测量电路模块、档位转换模块和显示模块组成。采用输入捕获方法替代传统等效采样技术，使系统在不需频段切换的情况下即可完成高精度测量。输入捕获技术适应性强，既能测量频率，也能测量周期和脉宽，简化了系统结构并提升了操作便捷性。

#### **1.3 电气指标**

1. **频率测量范围**：支持1Hz至99.9KHz的频率测量，显示精度为3位有效数字。
2. **周期测量范围**：1ms至1s。
3. **脉宽测量范围**：1ms至1s。
4. **测量精度**：输入捕获法使频率、周期和脉宽测量误差控制在0.5%以内。
5. **输入信号类型**：支持正弦波、三角波和矩形波，输入阻抗大于1MΩ，减少对信号源的影响。

#### **1.4 设计条件**

系统设计采用5V直流电源，逻辑电平符合TTL标准。为确保输入捕获技术的精度需求，系统选用高稳定性晶振作为参考时钟源，以保证测量准确性。

#### **1.5 扩展指标**

为更准确地显示测量值的小数精度，本系统在3位数码管上采用多位显示策略，以实现小数点后多位数字的展现，具体方案如下：

1. **动态小数点位置**：根据不同的测量范围，系统会自动调整小数点的位置。例如，在测量频率较低的情况下，显示的数值精确到小数点后两位，以提升显示的分辨率。系统通过数码管自带的动态控制电路，在适当位置点亮小数点，实现小数部分的显示。
2. **滚动显示精度扩展**：若小数点后需要显示的位数超过3位数码管的容量，系统可按段滚动显示整个数值。例如，显示一个精确到小数点后3位的结果时，系统会先显示整数位及小数点后前两位，再切换显示小数点后第3位的数字，实现更高精度的显示。

3位数码管能够灵活展现小数点后的多位数值，实现了测量结果的高精度显示，有效提高了系统的实用性和读数的直观性。

## 第二章 整体方案设计

### 2.1 算法设计

输入捕获是测量输入信号的频率、脉宽或周期的重要手段。基本原理是在时钟信号的控制下，通过捕获输入信号的边沿变化时间，计算输入信号的相关特性。FPGA 实现输入捕获时，凭借其并行处理能力，非常高效和灵活的。下面是部分算法原理的简述

### 2.1.1 FPGA 输入捕获原理

#### 2.1.1.1. 输入信号同步

由于 FPGA 的时钟与外部输入信号不一定同步，因此在捕获输入信号之前，首先需要对输入信号进行同步处理。常用的同步方法是通过双寄存器（或多级触发器）同步输入信号，以避免由于不同步带来的亚稳态问题。通过同步，输入信号才能在 FPGA 时钟域内稳定，从而保证信号捕获的正确性。

#### 2.1.1.2. 边沿检测

同步后的输入信号需要进行边沿检测。边沿检测是通过比较信号同步后的前后两拍状态，来确定输入信号是否发生了上升沿或下降沿。上升沿是输入信号从低电平转为高电平，下降沿则是信号从高电平转为低电平。通过此机制，可以精准地捕捉到信号的变化时刻。

#### 2.1.1.3. 捕获计数器

在 FPGA 中，输入捕获的关键在于记录输入信号边沿变化的时间。每个时钟周期都会增加一个计数器的值，计数器的值即表示当前时刻的时钟周期。捕获到边沿变化时，当前计数器的值会被保存，用于后续计算信号的周期或频率。

#### 2.1.1.4. 测量完成标志

为了标记一次输入捕获的完成，通常会引入一个测量完成信号。每当一次完整的周期被捕获后，系统就会通过该标志信号向上层模块或系统发出通知，表示输入捕获操作已经完成，可以进行后续的频率和周期的计算。

### 2.1.2 FPGA 四舍五入算法原理

在 FPGA 中实现四舍五入操作时，我们采用了一个基于 BCD（Binary-Coded Decimal，二进制编码十进制）表示的算法。该算法主要功能是将一个 24 位的 BCD 数字四舍五入到最近的十进制整数。四舍五入的具体处理规则如下：

1. **四舍五入规则**：  
   - 判断 BCD 数字的个位是否大于或等于 5。如果是，则向十位进位。
   - 如果个位数大于等于 5，则十位加一，并处理可能的进位问题（例如十位为 9 时，进位到百位）。
   - 对于每一位的进位，从个位开始逐级处理，直到高位。

2. **数据输入与输出**：  
   - 输入的 BCD 数字为 24 位，表示为六个 4 位的数字，每个 4 位数字代表一个十进制数。
   - 输出的 BCD 数字为 20 位，表示经过四舍五入后的结果。

#### 2.1.2.1 设计方案

该模块的设计基于时钟同步工作，并通过控制信号 `start` 和 `done` 来协调操作。设计流程如下：

- **输入分解**：  
   输入的 BCD 数字（24 位）被拆解为 6 个 4 位的 BCD 数字，每一位代表十进制的一个数位（从最高位的百万位到个位）。

- **四舍五入逻辑**：  
   - 通过比较个位的值与 5 进行判断。
   - 如果个位数大于或等于 5，则对十位进行加一处理，并考虑进位的传播。
   - 若某一位达到 9 以后，会发生进位，进位继续传递到高位，直到最高位（百万位）。

- **输出赋值**：  
   经处理后的每一位数字被存入输出寄存器中，并最终通过BCD编码输出。

- **状态控制**：  
   使用 `start` 信号启动四舍五入操作，使用 `done` 信号标记四舍五入操作完成。模块在 `start` 信号有效时开始工作，并在操作完成后通过 `done` 信号通知外部。

#### 2.1.2.2 四舍五入算法方框图及原理

**方框图**：

在整体方框图中，`BCD_Rounding` 模块包含以下主要部分：

1. **输入数据处理单元**：接收 24 位的 BCD 输入，将其分解为 6 个 4 位的数字（百万位到个位）。
2. **四舍五入模块**：判断个位数，若满足四舍五入条件，则依次加一并处理进位。
3. **输出寄存器**：将四舍五入后的结果存储为 20 位 BCD 数字。
4. **状态控制**：通过 `start` 和 `done` 信号控制操作的开始与结束。

**原理说明**：

- **四舍五入核心**：根据 BCD 数字的个位，判断是否需要向上进位。如果 `units_in >= 5`，则十位开始进位，依此类推直到高位。若某一位加一后超出 9，则将其置为 0，并将进位传递给下一位。
- **进位传播**：进位从低位（个位）开始，逐步向高位传播，直到最高位。若所有位都进位，最终输出将为零。

明白了，如果按照报告格式来写，可以按照以下结构进行编写。根据您给出的报告格式要求，模块的设计报告可以分为以下几部分：

---

### 2.1.3 FPGA 除数不是常数的除法转乘法算法

在本设计中，我们需要实现一个高效的除法器，用于计算常数除法操作，即将一个 32 位被除数除以常数 5000。为了提高性能，传统的除法操作被优化为乘法操作。具体做法是预计算常数 5000 的倒数，并将该倒数与被除数相乘，从而实现除法操作。由于常数倒数是一个固定值，因此这一优化可以有效减少硬件资源的使用，并提高运算速度。

- **常数倒数预计算**：  
  通过预计算 `1 / 5000` 乘以 `2^32`，得到了一个常数 `RECIPROCAL`，其值为 `32'd858993`。这一倒数值用于代替除法运算中的除数部分，避免了每次执行除法时的计算开销。

- **流水线结构设计**：  
  设计使用了三阶段流水线，其中第一阶段用于存储输入数据，第二阶段进行乘法计算，第三阶段输出商。流水线的引入使得系统能够在较短的时间内处理多个除法任务，提高了整体的吞吐量。

- **零除检测**：  
  当被除数为零时，输出结果应为零。因此，通过引入 `is_zero` 信号，检测被除数是否为零，若是零，则直接将商设为零。

#### 2.1.3.1 设计方案

本设计使用 Verilog HDL 实现，模块结构如下：

- **输入与输出**：
  - **输入**：32 位的被除数 `numerator`，时钟信号 `clk`，复位信号 `rst_n`。
  - **输出**：32 位的商 `quotient`，在计算完成后输出。
  
- **设计思路**：
  - 使用预计算的倒数 `1 / 5000 * 2^32`，并通过乘法代替除法来优化计算过程。
  - 采用三阶段流水线设计来提高并行性，减少运算延迟。
  - 对被除数为零的情况进行特殊处理，确保计算结果正确。

#### 2.2.3.2 整体方框图及原理

```
+--------------------------------------------+
|              Pipelined Divider             |
+--------------------------------------------+
|                                            |
|    +-------------------+   +------------+  |
|    |   Input (numerator) |   |   Output   |  |
|    |        (32 bit)     |---|  (quotient)|  |
|    +-------------------+   +------------+  |
|                                            |
|    +-------------------+   +------------+  |
|    |   Pre-calculated   |   |   Zero check|  |
|    |    Reciprocal      |---|    is_zero  |  |
|    +-------------------+   +------------+  |
|                                            |
|    +-------------------+   +------------+  |
|    |    Multiplier      |---|  Product   |  |
|    +-------------------+   +------------+  |
|                                            |
|    +-------------------+   +------------+  |
|    |    Output Register |---|   Quotient |  |
|    +-------------------+   +------------+  |
+--------------------------------------------+
```

- **模块组成**：
  - **Pre-calculated Reciprocal**：预计算的常数倒数 `1/5000 * 2^32`，用于加速除法操作。
  - **Multiplier**：乘法单元，用于将被除数与倒数相乘。
  - **Zero Check**：零除检测逻辑，用于判断被除数是否为零。
  - **Output Register**：存储计算结果的寄存器，输出最终商。

### 2.3 整体实现原理

1. **常数倒数的预计算**：
   为了避免每次除法时都进行计算，提前计算常数倒数。这里 `1 / 5000 * 2^32 ≈ 858993`，并将该常数作为 `RECIPROCAL` 存储。这个常数被用于加速除法操作。

2. **流水线处理**：
   模块通过三阶段流水线进行处理：
   - **阶段 1**：将被除数 `numerator` 和常数倒数 `RECIPROCAL` 存入寄存器。
   - **阶段 2**：执行乘法运算，计算结果存入 `product_reg`。
   - **阶段 3**：提取乘积的高 32 位作为商输出，并进行零除处理。

3. **商的计算**：
   商通过将乘积的高 32 位取出实现，由于乘法结果是 64 位，取高 32 位即为除法结果。若被除数为零，则输出商为零。

4. **性能优化**：
   通过使用常数倒数和乘法替代除法，显著提高了计算速度。流水线设计进一步提高了模块的吞吐量，使得模块能够高效执行多次除法操作。

### 2.2 设计方案

系统设计方案主要包括以下模块：

1. **输入捕获模块（Input_Capture_Module）**：负责输入信号的边沿检测和周期、脉宽的计数。该模块采用同步电路捕获信号边沿，利用计数器分别记录高电平和低电平时间。

2. **测量处理模块（Measurement_Processor）**：处理捕获的数据，计算出频率和周期，并将其转换为BCD格式以便于数码管显示。该模块包含除法运算器和BCD转换模块，实现频率和周期的小数点位置动态调整。

3. **显示控制模块（Hex8_Test）**：接收BCD格式的测量结果，并控制数码管的显示，包括小数点位置的动态调整和测量单位（频率和周期）的选择。

4. **主控模块（Top_Module）**：集成以上模块，通过 `mod_sel` 控制选择测量项目（周期或脉宽），并实时刷新显示输出。该模块协调各个子模块的数据流，保证测量数据的准确性。

### 2.3 整体方框图及原理

#### 整体方框图

```
                  +-------------------------------+
                  |           Top_Module          |
                  |-------------------------------|
                  |   mod_sel    |    clk, rst_n  |
                  |   (模式选择) |   (时钟、复位) |
                  |                               |
                  |     +--------------------+    |
                  |     |  Input_Capture     |    |
                  |     |    Module          |    |
                  |     |                    |    |
                  |     +--------------------+    |
                  |                               |
                  |     +--------------------+    |
                  |     | Measurement        |    |
                  |     | Processor          |    |
                  |     |                    |    |
                  |     +--------------------+    |
                  |                               |
                  |     +--------------------+    |
                  |     |    Hex8_Test       |    |
                  |     |  (Display Control) |    |
                  |     +--------------------+    |
                  |                               |
                  +-------------------------------+
```

#### 原理说明

1. **信号捕获与边沿检测**：`Input_Capture_Module` 通过时钟同步检测输入信号的上升沿和下降沿，以确定高电平和低电平的持续时间。检测到一个完整周期后，将测得的周期和脉宽信息发送至测量处理模块。

2. **测量处理与数值转换**：`Measurement_Processor` 接收周期时间或高电平时间，根据测量模式选择对频率或周期进行计算。通过除法和BCD转换实现对频率和周期的计算结果转换，并四舍五入后输出至显示控制模块。根据实际精度控制小数点位置。

3. **显示输出控制**：`Hex8_Test` 模块负责将测量数据输出至3位数码管，包括小数点的动态调整和单位显示，确保用户能够直观查看测量结果。

---

以上是第二章整体设计的各个环节和模块说明。该设计能够在不更换测量档位的情况下，实现高精度的测量和显示。
### 核心模块简介

1. **Top_Module**
   - 系统主模块，集成了输入捕获、测量处理和显示功能。
   - 通过 `mod_sel` 控制测量不同的信号参数（周期或高电平脉宽）。
   - 包含 `Input_Capture_Module` 进行输入信号的捕获，`Measurement_Processor` 处理测量数据，`hex8_test` 控制显示输出。

2. **Input_Capture_Module**
   - 输入捕获模块，用于测量输入信号的周期、高电平时间和低电平时间。
   - 通过检测信号的上升沿和下降沿实现周期和脉宽的测量。
   - 使用状态机分别处理高电平时间和低电平时间，并在完成时输出 `measurement_done` 信号。

3. **Measurement_Processor**
   - 测量处理模块，完成频率和周期的计算、转换成BCD码并四舍五入以便于显示。
   - `Iterative_Divider` 计算频率，通过将时钟频率除以周期时间得到频率。
   - `Binary_to_BCD` 和 `BCD_Rounding` 模块将二进制结果转换成BCD码并四舍五入。
   - 通过 `Segment_freq` 和 `Segment_period` 输出显示数据，并控制显示的小数点和单位标志位（`k` 和 `m`）。

4. **Hex8_Test**
   - 数码管显示模块，用于将BCD码的测量结果显示在7段数码管上。
   - 动态控制小数点位置，根据测量的精度要求显示不同的数位。

### 主要逻辑解释

- **频率测量**
   - `Iterative_Divider` 用于将时钟频率除以输入信号的周期时间，以计算频率。
   - 结果由 `Binary_to_BCD` 模块转换为BCD格式，以便在数码管上显示。
   - 四舍五入模块进一步提升精度，通过 `Segment_freq` 输出频率数据，`point_1` 控制小数点位置。

- **周期测量**
   - `Pipelined_Optimized_Divider_5000` 模块计算周期。
   - 类似于频率测量，周期也通过BCD转换和四舍五入以便显示。
   - `Segment_period` 输出周期数据，`point_2` 控制显示的小数点位置。

- **显示控制**
   - 根据测量结果动态控制小数点位置和数码管的单位标志，提供直观的显示。
   - 3位数码管用于显示测量精度，可根据需要调整小数点显示的位置。

### 显示和测量控制

代码中实现了对不同测量结果的显示，尤其是小数点位置和单位标志位的切换，通过 `Segment_freq` 和 `Segment_period` 输出对应的BCD码，使得结果能够准确显示在3位数码管上。
